#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "usage: bin/build <php|python|nodejs|golang|chromium> [flags...]" >&2
}

if [ $# -lt 1 ]; then
  usage
  exit 1
fi

LANG="$1"
shift

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SRC_DIR="$ROOT_DIR/tmp"
BUILD_ROOT="$ROOT_DIR/build"
LANG_KEY="$LANG"
BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
INSTALL_DIR="$BUILD_DIR/install"
TARGET_SYMLINK="$ROOT_DIR/horse"

if [ ! -d "$SRC_DIR" ]; then
  echo "error: missing $SRC_DIR (run bin/patch first)" >&2
  exit 1
fi

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: required command not found: $1" >&2
    exit 1
  fi
}

JOBS=1
if command -v getconf >/dev/null 2>&1; then
  JOBS="$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)"
fi

case "$LANG" in
  python)
    LANG_KEY="python"
    BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
    INSTALL_DIR="$BUILD_DIR/install"
    require_cmd make
    mkdir -p "$BUILD_DIR"
    if [ ! -f "$BUILD_DIR/Makefile" ]; then
      (cd "$BUILD_DIR" && "$SRC_DIR/configure" --prefix="$INSTALL_DIR" "$@")
    fi
    make -C "$BUILD_DIR" -j "$JOBS"
    make -C "$BUILD_DIR" install
    BUILT_BIN="$INSTALL_DIR/bin/python3"
    ;;
  php)
    LANG_KEY="php"
    BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
    INSTALL_DIR="$BUILD_DIR/install"
    require_cmd make
    mkdir -p "$BUILD_DIR"
    if [ ! -x "$SRC_DIR/configure" ]; then
      (cd "$SRC_DIR" && ./buildconf --force)
    fi
    if [ ! -f "$BUILD_DIR/Makefile" ]; then
      (cd "$BUILD_DIR" && "$SRC_DIR/configure" --prefix="$INSTALL_DIR" "$@")
    fi
    make -C "$BUILD_DIR" -j "$JOBS"
    make -C "$BUILD_DIR" install
    BUILT_BIN="$INSTALL_DIR/bin/php"
    ;;
  node|nodejs)
    LANG_KEY="nodejs"
    BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
    INSTALL_DIR="$BUILD_DIR/install"
    require_cmd make
    mkdir -p "$BUILD_DIR"
    if [ ! -f "$BUILD_DIR/Makefile" ]; then
      (cd "$BUILD_DIR" && "$SRC_DIR/configure" --prefix="$INSTALL_DIR" "$@")
    fi
    make -C "$BUILD_DIR" -j "$JOBS"
    make -C "$BUILD_DIR" install
    BUILT_BIN="$INSTALL_DIR/bin/node"
    ;;
  go|golang)
    LANG_KEY="golang"
    BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
    INSTALL_DIR="$BUILD_DIR/install"
    mkdir -p "$BUILD_DIR"
    (cd "$SRC_DIR/src" && ./make.bash "$@")
    mkdir -p "$INSTALL_DIR/bin"
    cp -a "$SRC_DIR/bin/." "$INSTALL_DIR/bin/"
    BUILT_BIN="$INSTALL_DIR/bin/go"
    ;;
  chromium)
    LANG_KEY="chromium"
    BUILD_DIR="$BUILD_ROOT/$LANG_KEY"
    INSTALL_DIR="$BUILD_DIR/install"
    mkdir -p "$BUILD_DIR"
    if ! command -v gn >/dev/null 2>&1; then
      echo "error: required command not found: gn" >&2
      exit 1
    fi
    if ! command -v ninja >/dev/null 2>&1; then
      echo "error: required command not found: ninja" >&2
      exit 1
    fi
    OUT_DIR="$BUILD_DIR/out"
    mkdir -p "$OUT_DIR"
    (cd "$SRC_DIR" && gn gen "$OUT_DIR" "$@")
    ninja -C "$OUT_DIR" chrome
    if [ -x "$OUT_DIR/chrome" ]; then
      BUILT_BIN="$OUT_DIR/chrome"
    elif [ -x "$OUT_DIR/chrome-wrapper" ]; then
      BUILT_BIN="$OUT_DIR/chrome-wrapper"
    else
      echo "error: built Chromium binary not found in $OUT_DIR" >&2
      exit 1
    fi
    ;;
  *)
    echo "error: unknown language: $LANG" >&2
    usage
    exit 1
    ;;
 esac

if [ ! -x "$BUILT_BIN" ]; then
  echo "error: built binary not found at $BUILT_BIN" >&2
  exit 1
fi

ln -sfn "$BUILT_BIN" "$TARGET_SYMLINK"

echo "Built $LANG at $BUILT_BIN"
echo "Symlinked $TARGET_SYMLINK -> $BUILT_BIN"
